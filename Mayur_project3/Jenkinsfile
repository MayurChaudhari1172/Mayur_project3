def CONFIG_FILE = 'Mayur_project3/deployment-config.yaml'

pipeline {
    agent any

    environment {
        TF_VERSION = '1.7.5'
        AWS_DEFAULT_REGION = 'us-east-1'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    if (!fileExists(CONFIG_FILE)) {
                        error "❌ Config file not found at ${CONFIG_FILE}"
                    }
                    CONFIG = readYaml(file: CONFIG_FILE)
                }
            }
        }

        stage('Terraform Init & Plan') {
            when {
                expression {
                    return env.BRANCH_NAME.startsWith('feature/') || env.BRANCH_NAME == 'dev'
                }
            }
            steps {
                script {
                    def envKey = env.BRANCH_NAME.startsWith('feature/') ? 'dev' : env.BRANCH_NAME
                    def modules = CONFIG[envKey]

                    modules.each { name, config ->
                        if (config.enabled && !config.disabled) {
                            dir(config.path) {
                                withEnv(["TF_IN_AUTOMATION=true"]) {
                                    sh "terraform init"
                                    if (config.containsKey('tfvars') && config.tfvars) {
                                        sh "terraform plan -var-file=${config.tfvars} -input=false"
                                    } else {
                                        sh "terraform plan -input=false"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Terraform Apply') {
            when {
                expression {
                    return env.BRANCH_NAME == 'dev' || env.BRANCH_NAME == 'stage' || env.BRANCH_NAME == 'main'
                }
            }
            steps {
                script {
                    if (env.BRANCH_NAME == 'stage' || env.BRANCH_NAME == 'main') {
                        input message: "Approve Apply for ${env.BRANCH_NAME}?"
                    }

                    def modules = CONFIG[env.BRANCH_NAME]
                    modules.each { name, config ->
                        if (config.enabled && !config.disabled) {
                            dir(config.path) {
                                withEnv(["TF_IN_AUTOMATION=true"]) {
                                    sh "terraform init"
                                    if (config.containsKey('tfvars') && config.tfvars) {
                                        sh "terraform apply -var-file=${config.tfvars} -auto-approve"
                                    } else {
                                        sh "terraform apply -auto-approve"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        failure {
            echo "❌ Terraform pipeline failed for ${env.BRANCH_NAME}"
        }
        success {
            echo "✅ Terraform pipeline completed successfully for ${env.BRANCH_NAME}"
        }
    }
}
